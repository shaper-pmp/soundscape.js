<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Soundscape</title>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8;" />
    
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="css/bootstrapSwitch.css">
    <link rel="stylesheet" href="css/soundscape.css">
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrapSwitch.js"></script>
    <script src="js/bootstrap.file-input.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="controls" class="row">
        <div class="span7">
          <div class="btn-group">
            <button id="play" class="btn" onclick="player.play();">Play</button>
            <button id="pause" class="btn" onclick="player.pause();">Pause</button>
          </div>
        </div>
        <div class="span3">
          <div class="btn-group">
            <button onclick="player.setVol(0);" class="btn"><i class="icon-volume-off"></i></button>
            <button onclick="player.changeVol(-0.1);" class="btn"><i class="icon-volume-down"></i></button>
            <button onclick="player.changeVol(0.1);" class="btn"><i class="icon-volume-up"></i></button>
          </div>
        </div>
      </div>
      <div id="audiocontainer"></div>
      <div class="row">
        <div class="span12">
          <a href="#new-audiotrack-modal" id="addchannel" class="btn" data-toggle="modal">Add channel</a>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      function test() {
      };
      
      // Multi-track player
      var player = {
        audioHolder: null,
        channels: {},
        nextChannelId: 0,
        
        init: function() {
          this.audioHolder = $("#audiocontainer");
          for(var i in this.channels) {
            this.createChannel(this.channels[i]);
          }
        },
        
        addChannel: function(channel) {
          channel = this.createChannel(channel);
          this.channels[channel.id] = channel;
          this.nextChannelId++;
          return channel.id;
        },
        
        createChannel: function(channel) {
          console.log(channel);
          channel.id = channel.id || this.nextChannelId;
          channel.loop_checked = channel.loop ? "checked" : "";
          var audio_element = template.do("audiotrack", channel);
          this.audioHolder.append(audio_element);
          
          channel.container = document.getElementById("track-"+channel.id);
          
          // Set up any bootstrap controls
          $('.loop', channel.container).bootstrapSwitch();
          
          channel.audio_element = document.getElementById("audio-"+channel.id);
          
          return channel;
        },
        
        removeChannel: function(track) {
          console.log(track);
          if(typeof track !== 'undefined') {
            $("#track-"+track).remove();
            delete this.channels[track];
          }
          else {
            for(var i in this.channels) {
              $("#track-"+i).remove();
              delete this.channels[i];
            }
          }
        },
        
        play: function(track) {
          if(typeof track !== 'undefined') {
            this.channels[track].audio_element.play();
          }
          else {
            for(var i in this.channels) {
              this.channels[i].audio_element.play();
            }
          }
        },
        
        pause: function(track) {
          if(typeof track !== 'undefined') {
            this.channels[track].audio_element.pause();
          }
          else {
            for(var i in this.channels) {
              this.channels[i].audio_element.pause();
            }
          }
        },

        setVol: function(level, track) {
          if(typeof track !== 'undefined') {
            this.channels[track].audio_element.volume = level;
          }
          else {
            for(var i in this.channels) {
              this.channels[i].audio_element.volume = level;
            }
          }
        },
        
        changeVol: function(increment, track) {
          if(typeof track !== 'undefined') {
            this.channels[track].audio_element.volume += increment;
          }
          else {
            for(var i in this.channels) {
              this.channels[i].audio_element.volume += increment;
            }
          }
        },
        
        setLoop: function(state, track) {
          if(typeof track !== 'undefined') {
            this.channels[track].audio_element.loop = state;
          }
          else {
            for(var i in this.channels) {
              this.channels[i].audio_element.loop = state;
            }
          }
        },
        
      };
      
      
      // Minimal templating system
      var template = {
        load: function(id) {
          return document.getElementById(id).innerHTML;
        },
        render: function(html, context) {
          for(var key in context) {
            var val = context[key];
            if(context[key] === true) {
              val = key;
            }
            if(val === false || typeof val === 'undefined') {
              val = "";
            }
            var regexp = new RegExp("{{"+key+"}}", "gi");
            html = html.replace(regexp, val);
          }
          return html;
        },
        do: function(id, context) {
          return this.render(this.load(id), context);
        }
      };
      
      
      // Init player on page-load
      $(document).ready(function() {
        player.init();
        // Render predefined channels
        player.addChannel({
            src: "rain-02.mp3",
            type: "audio/mp3",
            controls: true,
            loop: true,
        });
        player.addChannel({
            src: "64734%5Efrog11.mp3",
            type: "audio/mp3",
            controls: true,
            loop: false,
        });
        
        // Add event handlers
        /*$("#addchannel").on('click', function() {
          
        });*/
      });
    </script>
    
    <!-- Dialog boxes -->
    <div id="new-audiotrack-modal" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Add channel</h3>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="input-prepend input-append">
             <span class="add-on">URL</span>
            <input class="span2" id="src" type="text">
            <input class="add-on btn" id="src-local" type="file" onchange="
              var reader = new FileReader();
              console.log(this.files[0]);
              reader.addEventListener('load', function(event) {
                var mp3file = event.target;
                console.log(document.getElementById('src'));
                console.log(mp3file);
                var src_element = document.getElementById('src');
                src_element.value = mp3file.result;
                $('#filename-hint')[0].innerText = $('#src-local')[0].files[0].name;
                
                console.log(document.getElementById('src').value);
              });
              reader.readAsDataURL(this.files[0]);
            ">
          </div>
          <span class="label label-success" id="filename-hint"></span>
          
          <div class="switch loop" data-on-label="Loop" data-off-label="Once">
            <input type="checkbox" id="loop" />
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <a href="#" class="btn btn-primary" onclick="(function(self) {
          var form = $(self).closest('.modal');
          form.modal('hide');
          var newchannel = {
            src: form.find('#src').val(),
            type: 'audio/mp3',
            controls: true,
            loop: !!form.find('#loop:checked').val(),
          };
          var newid = player.addChannel(newchannel);
          player.play(newid);
        })(this);return false;">Save changes</a>
      </div>
    </div>
    
    <!-- Reusable templates -->
    <script type="text/x-html-template" id="audiotrack">
      <div class="audiotrack row" id="track-{{id}}">
        <audio class="span5" id="audio-{{id}}" src="{{src}}" {{controls}} {{loop}}></audio>
        <div class="span2">
          <div class="switch loop" data-on-label="Loop" data-off-label="Once">
            <input type="checkbox" {{loop_checked}} onchange="player.setLoop(this.checked, {{id}});" />
          </div>
        </div>
        <div class="span2">
          <div class="btn-group">
            <button onclick="player.setVol(0, {{id}});" class="btn" title="Mute volume" data-toggle="tooltip"><i class="icon-volume-off"></i></button>
            <button onclick="player.changeVol(-0.1, {{id}});" class="btn" title="Volume down" data-toggle="tooltip"><i class="icon-volume-down"></i></button>
            <button onclick="player.changeVol(0.1, {{id}});" class="btn" title="Volume up" data-toggle="tooltip"><i class="icon-volume-up"></i></button>
          </div>
        </div>
        <div class="span3">
          <button onclick="player.removeChannel({{id}});" class="btn btn-hover btn-hover-danger"><i class="icon-remove"></i></button>
        </div>
      </div>
    </script>
    
  </body>
</html>